# 개발 로그: 2025-12-11

## 요약 (Summary)
오늘의 작업은 스트레스 테스트를 위한 로깅 성능 최적화와 네트워크 배칭 효율성 모니터링 구현에 집중되었습니다.

## 주요 변경 사항 (Key Changes)

### 1. 파일 전용 로깅 (`LogFile`)
- **목표**: 스트레스 테스트 중 콘솔 출력 오버헤드를 줄이기 위해 로그를 *파일에만* 기록하도록 합니다.
- **구현**:
    - `ILog` 인터페이스에 `virtual void File(const std::string& msg) = 0;` 추가.
    - `LogImpl.cpp`에 콘솔 싱크를 우회하고 파일 싱크만 사용하는 전용 로거(`file_only`) 구현.
    - `System/ILog.h`에 `LOG_FILE(fmt, ...)` 및 `LOG_FILE_S(msg)` 매크로 추가.
    - **최적화**: 서버가 강제 종료되더라도 로그가 보존되도록 `spdlog::flush_every(std::chrono::seconds(1))` 설정 추가.

### 2. 네트워크 최적화 및 선형화 (수동 업데이트)
- **Writer 선형화 (Linearization)**:
    - `Writer.cpp`에 `Linearize` 로직을 구현하여 여러 개의 작은 패킷을 `async_write` 전에 하나의 큰 버퍼로 병합.
    - 메모리 할당을 줄이기 위해 `_linearBuffer` 도입.
    - 스레드 안전성을 위해 `lock-free queue`와 `atomic` 플래그를 사용하여 `Send` 최적화.
- **소켓 옵션**:
    - `TCP_NODELAY` 활성화.
    - `AsioSession`의 송수신 버퍼 크기를 4MB로 증가.
- **인터페이스 업데이트**:
    - 제로 카피 처리를 위해 `ISession` 및 `AsioSession`에 `Send(std::shared_ptr<std::vector<uint8_t>>)` 추가.
- **설정 (Configuration)**:
    - 테스트 단계에서 컨텍스트 스위칭 오버헤드를 최소화하기 위해 `server_config.json`의 워커 스레드 수를 1로 감소.

### 3. 배칭 효율성 모니터링
- **목표**: `Writer` 클래스가 여러 패킷을 하나의 시스템 호출로 얼마나 효과적으로 병합(`Linearize`)하는지 측정.
- **구현**:
    - `Writer` 클래스에 다음 통계 추적 기능 추가:
        - `Flush` 호출 횟수.
        - 처리된 총 아이템 수.
        - 최대 배치 크기.
    - `Writer::Flush`에 로직을 주입하여 매 1초마다 `LOG_FILE`을 사용해 통계 기록.
    - **결과**: 스트레스 테스트를 통해 서버가 패킷을 성공적으로 배칭하고 있음을 확인 (예: 부하 상태에서 플러시 당 평균 ~7.38 패킷).

### 4. 검증 (Verification)
- **스트레스 테스트**: `GameServer` (Release 빌드)에 대해 `DummyClient` (클라이언트 100개, 10초) 실행.
- **결과**:
    - 패킷 전송률 100% (~550k TPS).
    - `logs/server.log` 파일에 콘솔 오염 없이 배칭 통계가 성공적으로 기록됨.

## 참고 사항 (Notes)
- 디버깅/크래시 상황에서 로그가 기록되는 것을 보장하기 위해 `flush_every` 설정이 중요했습니다.
- 빈번한 성능 지표 기록에는 `LOG_FILE` 매크로를 사용해야 합니다.
