# 개발 로그: 2025-12-13

## 요약 (Summary)
오늘의 작업은 **"True Zero Allocation"** 패킷 시스템 구현과 서버 코어 루프의 **극한 성능 최적화**에 집중되었습니다. `boost::intrusive_ptr` 도입으로 오버헤드를 제거하고, TLS Pooling 및 Batch Processing을 통해 멀티스레드 경합(Contention)을 최소화하여 TPS를 비약적으로 향상시켰습니다.

## 주요 변경 사항 (Key Changes)

### 1. Zero Allocation Packet System (True Zero Allocation)
- **목표**: 패킷 생성 및 소멸 시 발생하는 런타임 힙 할당(Heap Allocation)을 0으로 만듦.
- **구현**:
    - **`System::Packet` 클래스**: `std::vector<uint8_t>`와 `refCount`를 내장(Composition)하여 가상 함수 오버헤드(Vtable) 제거.
    - **`boost::intrusive_ptr`**: `std::shared_ptr`의 Control Block 할당(24~40 bytes) 제거.
    - **`PacketPool`**: 패킷 객체 자체를 재사용하는 전용 메모리 풀 구현.
- **검증**: `PacketTest` 결과 100만 번 할당/해제 시 `Unique Addresses: 1` 달성 (완벽한 재사용).

### 2. PacketPool 성능 최적화 (2-Layer TLS Caching)
- **문제**: 워커 스레드 증가 시 Global Queue(`ConcurrentQueue`)에 대한 Lock 경합 발생.
- **해결**:
    - **L1 Cache (Thread Local)**: `thread_local` 벡터를 사용하여 락 없이 초고속 할당/해제 (LIFO).
    - **L2 Pool (Global)**: L1이 비거나 꽉 찼을 때만 500개 단위로 **Bulk Transfer** 수행.
- **효과**: 글로벌 락 접근 빈도를 1/500 수준으로 감소시켜 멀티스레드 확장성 확보.

### 3. Worker Loop 최적화 (Conditional Yielding)
- **문제**: 기존 루프가 패킷 처리 여부와 관계없이 무조건 `yield()`를 호출하여 불필요한 Context Switch 발생.
- **해결**:
    - `IDispatcher::Process`가 처리 여부(`bool`)를 반환하도록 수정.
    - **Hot Path**: 패킷 처리 시 `yield` 없이 즉시 다음 루프 진입 (CPU Cache 유지).
    - **Cold Path**: 큐가 비었을 때만 `yield` 호출.
- **효과**: 패킷이 쌓여있을 때 처리 속도(Throughput) 극대화.

### 4. Dispatcher 최적화 (Batch Processing)
- **문제**: 패킷 하나를 꺼낼 때마다 Atomic Operation 발생.
- **해결**: `try_dequeue_bulk`를 사용하여 한 번에 최대 **64개**의 패킷을 가져오도록 수정.
- **효과**: 큐 접근에 대한 Atomic Contention을 1/64로 감소.

### 5. 초기화 최적화 (Pre-allocation)
- **Pre-allocation**: 서버 시작 시 `PacketPool::Prepare(2000000)`을 호출하여 200만 개의 패킷을 미리 할당.
- **효과**: 서비스 초반 패킷 폭주 시(High Water Mark 도달 시) 발생할 수 있는 `new` 할당 지연 방지.

## 검증 및 테스트 (Verification)
- **`src/Tools/PacketTest`**: 새로운 통합 테스트 도구 추가.
    - Reference Counting 및 Address Stability(재사용성) 자동 검증.
- **통합 빌드**: `GameServer`, `DummyClient`, `PacketTest` 모두 성공적으로 빌드 및 실행 확인.

## 다음 단계 (Next Steps)
- 실제 부하 테스트(Stress Test)를 통한 TPS 측정.
- 로직 스레드(Logic Thread) 멀티스레딩 지원 검토.
