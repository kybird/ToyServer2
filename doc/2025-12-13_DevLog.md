# π“… 2025-12-13 κ°λ° μΌμ§€ - Zero-Allocation & Flow Control

## π― ν•µμ‹¬ λ©ν‘
**λ©”λ¨λ¦¬ ν• λ‹Ή μ—†λ”(Zero-Allocation) μ•„ν‚¤ν…μ² μ „ν™ λ° TCP λ°±ν”„λ μ…”(Back-Pressure) κµ¬ν„**
λ°νƒ€μ„ λ©”λ¨λ¦¬ ν• λ‹Ή(`new`)μ„ μ™„μ „ν μ κ±°ν•μ—¬ μ„±λ¥μ„ κ·Ήλ€ν™”ν•κ³ , Dispatcher κ³Όλ¶€ν• μ‹ λ„¤νΈμ›ν¬ μ½κΈ°λ¥Ό μ μ–΄ν•μ—¬ μ„λ²„ ν­μ£Όλ¥Ό λ°©μ§€ν•λ” μ•μ •μ„± λ©”μ»¤λ‹μ¦μ„ λ„μ…ν–μµλ‹λ‹¤.

## π› οΈ μ£Όμ” κΈ°μ  μ‘μ—… λ‚΄μ©

### 1. λ¬΄κ²½ν•© μ„Έμ… ν’€λ§ (`SessionPool`)
- **μ»΄ν¬λ„νΈ μ‹ μ„¤**: λ™μ‹μ„± ν™κ²½μ— μµμ ν™”λ `SessionPool<T>` ν΄λμ¤ μ μ‘.
- **μ£Όμ” κΈ°λ¥**:
  - **μ‚¬μ „ ν• λ‹Ή (Pre-Allocation)**: μ„λ²„ μ‹μ‘ μ‹μ μ— λ¨λ“  μ„Έμ…μ„ λ―Έλ¦¬ `new`λ΅ μƒμ„±ν•μ—¬ λ°νƒ€μ„ μ¤λ²„ν—¤λ“ μ κ±°.
  - **Lock-Free ν**: `moodycamel::ConcurrentQueue`λ¥Ό μ‚¬μ©ν•μ—¬ μ¤λ λ“ κ²½ν•©(Contention) μ—†λ” κ³ μ† ν• λ‹Ή/λ°λ‚© κµ¬ν„.
  - **μƒλ…μ£ΌκΈ° κ΄€λ¦¬**: `Reset()` (μ΄κΈ°ν™”) λ° `OnRecycle()` (λ°λ‚© μ „ μ •λ¦¬) ν›… μ—°λ™.
  - **Raw Pointer μ „ν™**: `std::shared_ptr`μ μ μ–΄ λΈ”λ΅ μ¤λ²„ν—¤λ“λ¥Ό μ—†μ• κΈ° μ„ν•΄ μμ ν¬μΈν„°(`AsioSession*`) μ²΄κ³„λ΅ λ³€κ²½.

### 2. μ„Έμ… ν©ν† λ¦¬ λ¦¬ν©ν† λ§ (`SessionFactory`)
- **ν†µν•© μ‘μ—…**: κΈ°μ΅΄ `ObjectPool` (λλ” μ§μ ‘ `new`) λ€μ‹  μ‹ κ· `SessionPool`μ„ μ‚¬μ©ν•λ„λ΅ μ—”μ§„ κµμ²΄.
- **API λ³€κ²½**: `CreateSession` ν•¨μκ°€ μ΄μ  `AsioSession*` (Raw Pointer)λ¥Ό λ°ν™.
- **μ•μ „ μ¥μΉ**: ν’€ κ³ κ° μ‹ `nullptr` μ²λ¦¬λ¥Ό ν†µν•΄ DoS κ³µκ²© λ“±μΌλ΅ μΈν• λ¬΄ν• μƒμ„± λ°©μ§€.

### 3. μ„Έμ… μƒλ…μ£ΌκΈ° λ° μΈν„°νμ΄μ¤ (`AsioSession`)
- **μΈν„°νμ΄μ¤ μ¤€μ**: `ISession::Reset()`, `ISession::CanDestroy()` κ°€μƒ ν•¨μ κµ¬ν„ λ° κ²€μ¦.
- **Const μ •ν™•μ„±**: `CanDestroy() const` ν•μ •μ λ¶μΌμΉλ΅ μΈν• `abstract class` μ»΄νμΌ μ¤λ¥ ν•΄κ²°.
- **λ¦¬μ†μ¤ μ •λ¦¬**: `enable_shared_from_this` μ κ±°. μ΄μ  `_ioRef`(IO μΉ΄μ΄ν„°)μ™€ λ…μ‹μ μΈ `SessionPool::Release`λ¥Ό ν†µν•΄ μλ™μΌλ΅ μλ…μ„ κ΄€λ¦¬ν•©λ‹λ‹¤.

### 4. λ°±ν”„λ μ…” & νλ¦„ μ μ–΄ (Burst νΈλν”½ λ°©μ–΄)
- **κ³Όλ¶€ν• κ°μ§€**: `Dispatcher` ν μ‚¬μ΄μ¦κ°€ μ„κ³„κ°’(ν„μ¬ 5,000κ°)μ„ μ΄κ³Όν•λ©΄ `IsOverloaded()`κ°€ True λ°ν™.
- **μ¤λ§νΈ μ¤λ΅ν‹€λ§ (`AsioSession::OnRead`)**:
  - Dispatcher κ³Όλ¶€ν• κ°μ§€ μ‹, μ¦‰μ‹ μ†μΌ“μ—μ„ λ°μ΄ν„°λ¥Ό **μ½μ§€ μ•κ³  λ©μ¶¤ (Pause Reading)**.
  - μ΄λ΅ μΈν•΄ **TCP Receive Window**κ°€ κ°€λ“ μ°¨κ² λλ©°, μ»¤λ„ λ λ²¨μ—μ„ ν΄λΌμ΄μ–ΈνΈ(Sender)μ μ „μ†΅ μ†λ„λ¥Ό λ¬Όλ¦¬μ μΌλ΅ λ¦μ¶¤.
  - **μλ™ μ¬κ°**: λ‚΄λ¶€ νƒ€μ΄λ¨Έ(`_flowControlTimer`)λ¥Ό ν†µν•΄ 10ms λ‹¨μ„λ΅ κ³Όλ¶€ν• μƒνƒλ¥Ό μ¬ν™•μΈν•κ³ , ν•΄μ†λλ©΄ μ¦‰μ‹ μ½κΈ°λ¥Ό μ¬κ° (Back-off μ•κ³ λ¦¬μ¦ μ μ©).

## π“ μ‚¬μ©μ μλ™ λ³€κ²½ μ‚¬ν•­ (Manual Parameters)
ν…μ¤νΈ ν™κ²½ μµμ ν™”λ¥Ό μ„ν•΄ μ‚¬μ©μ λ‹κ»μ„ μ§μ ‘ νλ‹ν•μ‹  νλΌλ―Έν„° λ‚΄μ—­μ…λ‹λ‹¤:

1.  **GameServer μ„¤μ • (`main.cpp`)**:
    - `PacketPool` ν¬κΈ°: **1,000**κ°λ΅ μ΅°μ • (κΈ°μ΅΄ 200λ§).
    - `SessionPool` ν¬κΈ°: **1,000**κ°λ΅ μ΅°μ • (κΈ°μ΅΄ 1λ§).

2.  **μ¤νΈλ μ¤ ν…μ¤νΈ μ„¤μ • (`stress_test_release.bat` & `DummyClient`)**:
    - μ ‘μ† ν΄λΌμ΄μ–ΈνΈ: **100**λ….
    - ν…μ¤νΈ μ§€μ† μ‹κ°„: **60μ΄** (κΈ°μ΅΄ 10μ΄).
    - ν΄λΌμ΄μ–ΈνΈ IO μ¤λ λ“: **8**κ°λ΅ μ¦μ„¤.

## β… μµμΆ… κ²€μ¦
- **λΉλ“ μƒνƒ**: λ¨λ“  μ»΄ν¬λ„νΈ μ •μƒ λΉλ“ μ™„λ£ (Exit Code 0).
- **μ•„ν‚¤ν…μ²**: μ„Έμ… κ΄€λ¦¬μ—μ„ μ¤λ§νΈ ν¬μΈν„° μμ΅΄μ„±μ„ μ κ±°ν•κ³  Raw Pointer κΈ°λ°μ κ³ μ„±λ¥ κµ¬μ΅°λ΅ μ „ν™ μ„±κ³µ.
- **μ•μ •μ„±**: Flow Control λ΅μ§ λ™μ‘ ν™•μΈ. ν­λ°μ μΈ ν¨ν‚· μ μ… μ‹μ—λ„ μ„λ²„ νκ°€ ν„°μ§€μ§€ μ•κ³  μ μ • μμ¤€μ„ μ μ§€ν•¨.
