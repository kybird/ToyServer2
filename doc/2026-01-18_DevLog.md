# 2026-01-18 개발 로그

## 승리 조건 구현

### 배경
마지막 웨이브(65초 시작, 999초 지속)가 종료되면 몬스터 생성은 중단되지만, 게임 종료나 승리 처리 로직이 없어 "평화 모드"로 무한 지속되는 문제 발견.

### 요구사항
- 모든 웨이브 종료 + 모든 몬스터 처치 시 승리 팝업 및 게임 종료

### 설계 원칙 (v3 계획)
1. **이벤트 기반 카운트**: 매 프레임 순회 대신 생성/제거 시 카운트 증감
2. **명시적 상태 관리**: `WaveState` enum으로 웨이브 상태 표현
3. **책임 분리**: WaveManager는 스폰 상태, Room은 승리 판정
4. **Despawn 기준**: IsDead()가 아닌 실제 제거 시점 기준 카운트

### 구현 내용

#### 1. ObjectManager - 몬스터 카운트 자동 관리
**파일**: [`ObjectManager.h`](file:///c:/Project/ToyServer2/src/Examples/VampireSurvivor/Server/Game/ObjectManager.h)

```cpp
// 멤버 변수
int32_t _aliveMonsterCount = 0;

// AddObject에서 몬스터 타입 체크 후 ++
// RemoveObject에서 몬스터 타입 체크 후 --
// Debug 빌드: assert(_aliveMonsterCount > 0)
```

**핵심**: 외부에서 카운트를 직접 조작하지 않고 ObjectManager 내부에서 자동 관리하여 휴먼 에러 방지.

#### 2. WaveManager - WaveState Enum
**파일**: [`WaveManager.h`](file:///c:/Project/ToyServer2/src/Examples/VampireSurvivor/Server/Game/WaveManager.h), [`WaveManager.cpp`](file:///c:/Project/ToyServer2/src/Examples/VampireSurvivor/Server/Game/WaveManager.cpp)

```cpp
enum class WaveState { NotStarted, InProgress, Completed };

// Start(): NotStarted → InProgress
// Update(): 1회성 전이 (InProgress → Completed)
// Reset(): NotStarted로 초기화
```

**핵심**: 상태 전이를 1회성으로 제한하여 중복 로그 방지 및 확장성 확보.

#### 3. Room - 승리 조건 판정
**파일**: [`Room.h`](file:///c:/Project/ToyServer2/src/Examples/VampireSurvivor/Server/Game/Room.h), [`Room.cpp`](file:///c:/Project/ToyServer2/src/Examples/VampireSurvivor/Server/Game/Room.cpp)

```cpp
bool Room::CheckWinCondition() const
{
    return _waveMgr.IsAllWavesComplete() && _objMgr.GetAliveMonsterCount() == 0;
}

// Room::Update 내부
if (!_isGameOver)
{
    _waveMgr.Update(deltaTime, this);
    if (CheckWinCondition())
    {
        HandleGameOver(true);  // 승리!
    }
}
```

**핵심**: 조건 판정 로직을 별도 함수로 분리하여 테스트 용이성 및 확장성 확보.

### 빌드 결과
✅ **빌드 성공** - 컴파일 오류 없음

### 검증 계획
1. `WaveData.json` duration을 짧게 수정 (5초, 10초)
2. 서버 실행 후 클라이언트 접속
3. 모든 웨이브 종료 + 몬스터 처치 시 `S_GameOver` 패킷 (`is_win=true`) 수신 확인

### 향후 확장 가능성
현재 구조는 다음 확장을 쉽게 지원:
- 보스 웨이브 추가
- 시간 제한 승리 조건
- 특수 오브젝트 파괴 조건
- 무한 웨이브 모드

---

## 참고
- Implementation Plan: v3 (이벤트 기반 카운트, WaveState enum, CheckWinCondition 분리)
- 리뷰 피드백 반영: ObjectManager 내부 관리, Debug assert, 1회성 상태 전이
