# 수정 및 구현 보고서 (2026-02-12)

오늘 진행된 `doc/todo.md` 항목들에 대한 수정 내역 및 기술적 개선 사항입니다.

## 1. 클라이언트 (Unity) 시각적 개선

### 정렬 순서 (Z-Order) 수정
-   **파일**: `ExpGemController.cs`
-   **내용**: 경험치 보석이 몬스터(박쥐 등) 위에 렌더링되어 가독성을 해치는 문제를 해결했습니다.
-   **조치**: `Start()` 시점에 `Sorting Order`를 `-1`로 강제 설정하여 보석이 항상 유닛의 뒤쪽 바닥에 표시되도록 수정했습니다.

### 피격 효과 (SimpleFlash) 개선
-   **파일**: `SimpleFlash.cs`
-   **내용**: 박쥐와 같이 자식 오브젝트가 여러 개인 경우 피격 시 일부만 깜빡이거나 효과가 없는 문제를 해결했습니다.
-   **조치**: 자식 오브젝트의 모든 `SpriteRenderer`와 `MeshRenderer`를 리스트로 추적하여, 피격 시 전체가 동시에 빨간색으로 깜빡이도록 개선했습니다.

## 2. 서버 (C++) 스킬 로직 고도화

### 채찍 (Whip) - OBB 판정 도입
-   **파일**: `DamageEmitter.cpp`
-   **내용**: 기존 원형 판정에서 시각적 이펙트와 일치하는 **회전된 직사각형 (OBB, Oriented Bounding Box)** 판정으로 변경했습니다.
-   **조치**: 플레이어가 바라보는 방향(벡터)을 기준으로 몬스터의 좌표를 로컬 좌표계로 회전 변환하여 직사각형 내부에 있는지 검사합니다. 정밀한 타격 판정이 가능해졌습니다.

### 성서 (Bible) - 공전(Orbit) 이동 로직 구현
-   **파일**: `Projectile.h`, `Projectile.cpp` (신규)
-   **내용**: 플레이어 주변을 회전하는 투사체 패턴을 구현했습니다.
-   **조치**: 
    -   `Projectile::UpdateOrbit` 구현: 소유자의 위치를 매 프레임 추적하며 `sin`, `cos` 기반으로 회전 좌표를 계산합니다.
    -   클라이언트의 Dead Reckoning(추측 항법)을 위해 회전 방향에 따른 물리 속도(`VX`, `VY`)를 업데이트하여 동기화의 부드러움을 높였습니다.
    -   헤더 순환 참조 방지를 위해 `Projectile` 구현부를 `.cpp`로 분리했습니다.

### 마늘 (Garlic) - 펄스 로직 개선 및 디버깅
-   **파일**: `DamageEmitter.cpp`
-   **내용**: 주변 오라에 닿아도 데미지가 들어가지 않는 것처럼 보이는 현상을 진단하고 로직을 보강했습니다.
-   **조치**: AoE 펄스 타격 시마다 타겟 수와 데미지 정보를 서버 로그로 상세히 출력하도록 개선했습니다(`LOG_INFO`, `LOG_DEBUG`). 또한 크리티컬 시스템을 통합했습니다.

## 3. 동기화 및 UI 개선

### HP 바 시스템 실시간 동기화
-   **파일**: `Player.cpp`, `Room.cpp`, `Player.h`
-   **내용**: 패시브 아이템(최대 체력 증가 등) 획득 시 UI에 즉시 반영되지 않는 문제를 해결했습니다.
-   **조치**: `ApplySkills` 및 `RefreshInventoryEffects` 함수 내부에서 최대 체력이 변경되는 즉시 `S_HpChange` 패킷을 브로드캐스트하도록 수정했습니다.

### 경험치(XP) 바 동기화 디버깅
-   **파일**: `PacketHandler.cs`
-   **내용**: 경험치바가 간헐적으로 출렁이는(역행하는) 현상을 진단하기 위한 안전장치를 마련했습니다.
-   **조치**: 이전 패킷의 경험치 값과 레벨을 정적 변수로 유지하며, 만약 현재 레벨에서 경험치 값이 이전보다 감소하여 도착할 경우 `Debug.LogWarning`을 통해 경고를 발생시킵니다. 이를 통해 서버 로직 오류인지 네트워크 순서 문제인지 판별할 수 있습니다.

---
**보고자**: Antigravity (Senior Full-stack Architect)
**날짜**: 2026-02-12
