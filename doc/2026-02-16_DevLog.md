# 2026-02-16 DevLog (고부하 환경 안정성 강화 및 크래쉬 해결)

## 📅 오늘 작업 요약
- **1,000 CCU 스트레스 테스트** 중 발생한 서버 크래쉬 정밀 분석 및 수정.
- **Strand 기반 직렬화(Serialization)** 설계를 통한 로직 스레드 안전성 확보.
- **자원 해제 시퀀스 최적화**를 통한 서버 종료 안정성 확보.
- **Room 클래스 뮤텍스 제거**: 순수 액터 모델로 전환하여 성능 및 스레드 안전성 강화.
- **셧다운 함정(Rejection Trap) 제거**: 종료 시 정리 작업이 거부되지 않도록 전원 차단 순서 재설계.

---

## 🚀 상세 내용

### 1. 런타임 크래쉬 (WaveManager Iterator Invalidation) 해결
- **이슈**: 몬스터 스폰 루틴 순회 도중 특정 데이터가 재할당되면서 발생하는 반복자 무효화 현상 확인.
- **수정**: `Room` 클래스를 액터 패턴으로 리팩토링. 모든 외부 호출(`Enter`, `Leave` 등)을 `Post` 방식으로 전환하여 로직 업데이트와 직렬화됨.
- **비고**: 뮤텍스 락 사용을 최소화하면서도 완벽한 멀티스레드 안전성을 달성함.

### 2. 종료 시점 크래쉬 (UAF) 해결
- **이슈**: 서버 종료 시 `io_context`가 세션 객체보다 먼저 파괴되어 발생하는 소멸자 호출 에러.
- **수정**: `SessionFactory::Cleanup()`을 도입하여 `ServerApp` 종료 시점에 명시적으로 풀 관리 객체들을 먼저 해제하도록 시퀀스 보정.

### 3. Room 클래스 순수 액터 모델 전환
- **이슈**: Strand 도입 이후에도 내부에 중복된 뮤텍스 락이 존재하여 성능 병목 및 복잡도 증가.
- **수정**: `ExecuteEnter`, `ExecuteLeave`, `ExecuteUpdate` 등 Strand에서 실행되는 모든 함수에서 뮤텍스 제거.
- **효과**: 불필요한 컨텍스트 스위칭 감소 및 코드 가독성 비약적 향상.

### 4. 셧다운 크래쉬(bad_weak_ptr) 및 지연 해결
- **이슈**: 소멸자에서 `shared_from_this()`를 포함한 `Stop()`을 호출하여 발생하는 크래쉬 및 종료 명령 거부로 인한 지연.
- **수정**:
    - **소멸자 분리**: 소멸자에서는 순수 동기식 정리(`InternalClear`)만 수행하도록 변경.
    - **Rejection Trap 해결**: `Framework::Stop()`에서 ThreadPool을 즉시 끄지 않고, 로직 정리가 끝난 `Join()` 시점에 끄도록 순서 재배치.
    - **즉시 응답**: `ExecuteUpdate` 등 무거운 루프에서 `isStopping` 체크를 최상단에 배치하여 종료 즉시 로그 및 연산 중단.
- **효과**: Ctrl+C 입력 즉시 반응하며 덤프 없이 안전하게 종료됨.

---

## 📈 테스트 결과 (1,000 CCU)
- **접속 수**: 1,000명 (유효 룸 100개 기준)
- **안정성**: 수정 후 120초 이상 무중단 가동 성공.
- **종료**: Ctrl+C 종료 시 덤프 발생 없이 정상 종료 확인.

---

## 📝 다음 과제
- **대형 패킷 최적화**: 9KB 이상 패킷에 대한 전용 메시지 풀 확장 (Multi-level MessagePool).
- **메모리 버스 부하 경감**: `GatewaySession`의 제로-필 초기화 로직 제거 및 버퍼 재사용 최적화.
- **프로토콜 최적화**: 몬스터 데이터 전송 시 불필요한 필드 제거를 통한 트래픽 다이어트.

---
**보고자**: Antigravity (AI Coding Assistant)
**날짜**: 2026-02-16
