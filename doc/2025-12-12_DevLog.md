# Dev Log: 2025-12-12

## Summary
Today's work focused on optimizing logging performance for stress testing and implementing monitoring for network batching efficiency.

## Key Changes

### 1. File-Only Logging (`LogFile`)
- **Objective**: Reduce console output overhead during stress tests by allowing logs to be written *only* to the file sink.
- **Implementation**:
    - Added `virtual void File(const std::string& msg) = 0;` to `ILog` interface.
    - Implemented a dedicated `file_only` logger in `LogImpl.cpp` that bypasses the console sink.
    - Added `LOG_FILE(fmt, ...)` and `LOG_FILE_S(msg)` macros in `System/ILog.h`.
    - **Optimization**: Added `spdlog::flush_every(std::chrono::seconds(1))` to ensuring logs are preserved even if the server is terminated forcefully.

### 2. Network Optimization & Linearization (Manual Updates)
- **Writer Linearization**:
    - Implemented `Linearize` logic in `Writer.cpp` to coalesce multiple small packets into a single large buffer before `async_write`.
    - Introduced `_linearBuffer` to reduce memory allocations.
    - Optimized `Send` to use `lock-free queue` and `atomic` flags for thread safety.
- **Socket Options**:
    - Enabled `TCP_NODELAY`.
    - Increased Send/Recv buffer sizes to 4MB in `AsioSession`.
- **Interface Updates**:
    - Added `Send(std::shared_ptr<std::vector<uint8_t>>)` to `ISession` and `AsioSession` for zero-copy handling.
- **Configuration**:
    - Reduced worker threads to 1 in `server_config.json` to minimize context switching overhead during this phase of testing.

### 3. Batching Efficiency Monitoring
- **Objective**: Measure how effective the `Writer` class is at coalescing multiple packets into a single system call (`Linearize` logic).
- **Implementation**:
    - Modified `Writer` class to track:
        - `Flush` call count.
        - Total items processed.
        - Maximum batch size.
    - Injected logic in `Writer::Flush` to calculate and log these statistics every 1 second using `LOG_FILE`.
    - **Result**: Confirmed via stress testing that the server is successfully batching packets (e.g., Avg Batch ~7.38 packets per flush under load).

### 3. Verification
- **Stress Test**: Ran `DummyClient` (100 clients, 10s) against `GameServer` (Release build).
- **Outcome**: 
    - 100% packet delivery (~550k TPS).
    - `logs/server.log` successfully recorded batching statistics without polluting the console.

## Notes
- To confirm logs are written during debugging/crashes, `flush_every` was crucial.
- `LOG_FILE` macro should be used for high-frequency performance metrics.
