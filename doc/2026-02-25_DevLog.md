# 개발 일지 (DevLog) - 2026-02-25

## 📌 주요 작업 내역 요약

오늘은 서버 구조 전반에 걸친 아키텍처 정립, 최적화 리팩토링, 그리고 클라이언트(Unity)와의 핵심 연동 기반(맵 데이터 동기화)을 마련하는 굵직한 작업들을 진행했습니다.

### 1. TileMap 기반 충돌 및 이동 시스템 설계 완료
* Tiled 맵 데이터를 기반으로 서버 내 물리 처리를 위한 **TileMap Collision Design** 명세 확정.
* Sweep 결함 검사기(AABB), 타일 충돌, 좌표계 기준(Origin), 그리고 가장 중요한 슬라이딩(Collision Response) 정책들에 대한 구체적인 알고리즘과 가이드라인을 정립했습니다.

### 2. SpatialGrid 및 EventBus 핵심 코어 리팩토링
* **SpatialGrid (공간 그리드 최적화)**: 레거시 코드(`Add`, `Remove`, `Update` 등)를 정리하고, 헤더(.h)에 있던 무거운 구현부(`Rebuild`, `GetNeighborCells` 등)를 소스(.cpp)로 완전히 분리시켜 캡슐화와 빌드 속도 개선을 이뤄냈습니다.
* **EventBus (이벤트 시스템 고도화)**: 기존의 Lock 기반 이벤트 처리를 개선하여 Copy-On-Write 패턴 기반의 Lock-free 형태 디자인으로 전환. 세션 연결 해제, 물리 방 입장 등 시스템 단의 이벤트를 GamePacketHandler 등에서 더욱 깔끔하고 안전하게 처리할 수 있도록 리팩토링했습니다. (+ `Declaration requires an exit-time destructor` 등 C++ 컴파일 타임 에러 수정)

### 3. 클라이언트-서버 Map ID (map_id) 프로토콜 동기화 (가장 시간 소요 큼)
* **목표**: Unity 클라이언트가 여러 개의 맵 중 어떤 맵의 에셋(`.tmx`)과 충돌 레이어를 세팅할지 알 수 있도록 서버와 `map_id` 연동.
* **Protocol (`game.proto`)**: `C_CreateRoom`, `S_CreateRoom`, `RoomInfo`, `S_JoinRoom` 메시지들에 `map_id` 속성 삽입 및 `generate_packets.py / .bat` 스크립트를 통한 재생성.
* **Handlers & Room**: 요청에서 건네져 온 `map_id`를 `RoomManager`를 거쳐 `Room` 인스턴스의 생성자 인자로 삽입하고, 내부 `_mapId` 변수에 저장하여 이 ID를 기반으로 `TileMap`을 로딩하도록 파이프라인 전면 개편.
* **Troubleshooting**: `Room` 생성자 시그니처가 완전히 바뀜에 따라 관련되었던 사실상 모든 Unit Test File들(`TestCombat.cpp`, `TestRoom.cpp` 등)에서 대규모 빌드 에러가 발생. 파일 전체를 순회하며 수정 조치하고 `#include` 순환 참조 문제를 전방 선언(Forward Declaration)으로 대체하여 의존성을 끊어내어 빌드를 최종 성공시켰습니다.

---

## 💡 향후 계획 및 과제 (Next Steps)
1. **클라이언트 맵 연동 후속 조치**: 서버의 Dummy 파일인 `Map01.json` 레이아웃과 일치하는 실제 Unity 쪽 시각적 타일 맵 에셋(`.tmx`) 제작 및 검증.
2. **충돌 처리 스크립트화**: 오늘 디자인한 TileMap Collision Design의 명세대로 서버 쪽에 Sweep Test(물리 엔진) 기능 상세 코딩 진행.
3. 생성된 `map_id`를 바탕으로, 클라이언트에서 Tiled 맵이 정상적으로 불러와지고 서버와 바운더리가 같은지 테스트.

---
**비고:**
수많은 패킷 구조 변경과 리팩토링이 교차되어 빌드 에러 체이닝이 길게 일어났지만, 최종적으로 모두 정리되어 `UnitTests` 통과 및 Build Success를 확인했습니다. 수고하셨습니다!
